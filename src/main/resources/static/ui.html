<!DOCTYPE html>
<html lang="en">

<head>
    <title>Student Information</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/htmx.org/dist/htmx.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/hyperscript.org/dist/_hyperscript.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        $(document).ready(function () {
            $("#updateStudentForm").submit(function (event) {
                event.preventDefault();

                var formData = {
                    firstName: $("#firstName").val(),
                    lastName: $("#lastName").val(),
                    cnp: $("#cnp").val(),
                    birthDate: $("#birthDate").val(),
                    studyYear: $("#studyYear").val(),
                    studyLevel: $("#studyLevel").val(),
                    fundingForm: $("#fundingForm").val(),
                    graduatedHighSchool: $("#graduatedHighSchool").val()
                };

                console.log(formData);

                $.ajax({
                    type: "POST",
                    url: "/api/students/addStudent",
                    contentType: "application/json",
                    data: JSON.stringify(formData),
                    success: function (response) {
                        console.log(response);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("AJAX Error:", textStatus, errorThrown);
                        alert("Error: " + textStatus);
                    }
                });
            });

            function getCurrentStudent() {
                return document.getElementById("cnp").value;
            }

            document.addEventListener('htmx:afterRequest', function (evt) {
                if (evt.detail.target.id === 'updateStudentForm') {
                    if (evt.detail.xhr.status === 404) {
                        return alert("Error: Could Not Find Resource");
                    }
                    if (evt.detail.successful !== true) {
                        alert("Unexpected Error");
                        console.error(evt);
                    }
                    if (evt.detail.target.id === 'updateStudentForm') {
                        var responseData = JSON.parse(evt.detail.xhr.response);
                        document.getElementById('firstName').value = responseData.firstName;
                        document.getElementById('lastName').value = responseData.lastName;
                        document.getElementById('cnp').value = responseData.cnp;
                        document.getElementById('birthDate').value = responseData.birthDate;
                        document.getElementById('studyYear').value = responseData.studyYear;
                        document.getElementById('studyLevel').value = responseData.studyLevel;
                        document.getElementById('fundingForm').value = responseData.fundingForm;
                        document.getElementById('graduatedHighSchool').value = responseData.graduatedHighSchool;
                    }
                }
            });
        });
    </script>
</head>

<body>
<h1>Student Information</h1>

<form id="updateStudentForm" hx-post="/api/students/updateInfo" hx-trigger="submit" hx-headers="{'Content-Type': 'application/json'}">
    <label for="firstName">First Name:</label>
    <input type="text" id="firstName" name="firstName" required>
    <label for="lastName">Last Name:</label>
    <input type="text" id="lastName" name="lastName" required>
    <label for="cnp">CNP:</label>
    <input type="text" id="cnp" name="cnp" required>
    <label for="birthDate">Birth Date:</label>
    <input type="date" id="birthDate" name="birthDate" required>
    <label for="studyYear">Study Year:</label>
    <input type="number" id="studyYear" name="studyYear" required>
    <label for="studyLevel">Study Level:</label>
    <input type="text" id="studyLevel" name="studyLevel" required>
    <label for="fundingForm">Funding Form:</label>
    <input type="text" id="fundingForm" name="fundingForm" required>
    <label for="graduatedHighSchool">Graduated High School:</label>
    <input type="text" id="graduatedHighSchool" name="graduatedHighSchool" required>
    <button type="submit">Update Student Info</button>
</form>

<button type="button" hx-get="/api/students/getInfo" hx-trigger="click" hx-target="#updateStudentForm" hx-vals="js:{cnp: getCurrentStudent()}" hx-swap="none">Get User Info</button>
<script rel="stylesheet" src="script.js"></script>
</body>
</html>
